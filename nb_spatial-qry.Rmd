---
title: "Spatial Queries and Joins"
output: 
  html_notebook: 
    css: nb.css
---

```{r setup}
library(sf)
library(units)
library(tibble)
```

# Example: Find POIs that Intersect the Merced Watershed

Start by importing the watersheds, grouping by HU (larger watershed units):

```{r}
## Import the watersheds, grouping by HUNAME
gpkg_watershd_fn <- "./data/yose_watersheds.gpkg"
yose_hu_watersheds <- st_read(gpkg_watershd_fn, layer="calw221") %>% 
  group_by(HU) %>% 
  summarise(HUNAME = first(HUNAME), NUM_WATERSHEDS = n())
```

Pull out just the Merced watershed and plot it:

```{r}
## Filter out just the Merced River watershid
merced_watershed <- yose_hu_watersheds %>% dplyr::filter(HUNAME == "MERCED RIVER")

## Plot boundaries
plot(yose_hu_watersheds %>% st_geometry())
plot(merced_watershed %>% st_geometry(), add=TRUE, col="lightpink")
```

Next import the points of interest:

```{r}
## Import points of interest
yose_poi <- st_read(dsn="./data", layer="yose_poi") 
```

Apply the intersects test:

```{r}
merced_poi <- yose_poi %>% st_intersects(merced_watershed)
```

ERROR message! Spatial querying requires features to be in the same crs!

Project the HU watershed layer (which is in Albers) to match the points of interest (which are UTM):

```{r}
yose_hu_utm <- yose_hu_watersheds %>% st_transform(st_crs(yose_poi))
merced_hu_utm <- yose_hu_utm %>% dplyr::filter(HUNAME == "MERCED RIVER")
```

Try the intersects test again:

```{r}
yose_poi_merced_yn <- yose_poi %>% st_intersects(merced_hu_utm, sparse=FALSE)
head(yose_poi_merced_yn)
```

## YOUR TURN!

How many points intersect the Merced Rivershed watershed polygon?

```{r}
## How many points of interest call in the Merced River watershed?

```

Plot the results to make sure:

```{r}
## Extract the points that intersect the watershed to a new sf object
merced_poi <- yose_poi %>% filter(yose_poi_merced_yn[,1])

## Plot
plot(yose_hu_utm  %>% st_geometry(), border="gray70")
plot(merced_hu_utm %>% st_geometry(), add=TRUE, col="lightpink")
plot(yose_poi %>% st_geometry(), col="gray30", pch=16, cex=0.5, add=TRUE)
plot(merced_poi %>% st_geometry(), col="darkgreen", pch=16, cex=0.8, add=TRUE)
```

# Example: Generating Random Points inside an Irregular Polygon

First, we import the boundary and generate 1500 points within the bounding box:

```{r}
## Import the Yosemite border
yose_bnd_ll <- st_read(dsn="./data", layer="yose_boundary")
```

Next, generate uniformly distributed random numbers between the x and y ranges

```{r}
n <- 500
yose_ext <- st_bbox(yose_bnd_ll)
xs <- runif(n * 3, min = yose_ext[1], max = yose_ext[3])
ys <- runif(n * 3, min = yose_ext[2], max = yose_ext[4])
```

Create a sf object from the random points

```{r}
rand_pts <- st_as_sf(data.frame(lon = xs, lat = ys), 
                     coords = c("lon", "lat"), 
                     crs=st_crs(yose_bnd_ll))

## Plot
plot(rand_pts, axes=T, pch=16, cex=0.5)
```

Next, test which points fall within the park boundary, and save those to a new object.

```{r}
## Test which points are within the YNP boundary
in_yose_mat <- st_within(rand_pts, yose_bnd_ll, sparse = FALSE)
head(in_yose_mat)

## Save those in the park to a new sf object
pts_in_park <- rand_pts %>% filter(in_yose_mat[,1])
nrow(pts_in_park)
```
Plot the results:

```{r}
tm_shape(yose_bnd_ll) + tm_borders(col="palegreen4", lwd = 4) +
  tm_shape(pts_in_park) + tm_dots(size = 0.1, col="gray20")
```

Lastly, all we need is 500 points so take a random sample:

```{r}
## Take a random sample of the points 
pts_in_park_500 <- pts_in_park %>% sample_n(n)

## Plot
tm_shape(yose_bnd_ll) + tm_borders(col="palegreen4", lwd = 4) +
  tm_shape(pts_in_park_500) + tm_dots(size = 0.1, col = "gray20")
```

# Example: Find the closest trail to each campground

```{r}
## FIND THE CLOSEST TRAIL TO EACH CAMPGROUND

## Define a convenience variable for UTM Zone 11
epsg_utm11n_nad83 <- 26911

## Import the campgrounds
yose_campgrnds_utm <- st_read(dsn="./data", layer="yose_poi") %>% 
  dplyr::filter(POITYPE == 'Campground') %>% 
  dplyr::select(POINAME) %>% 
  st_transform(epsg_utm11n_nad83)

## Import the trails
gdb_fn <- "./data/yose_trails.gdb"
file.exists(gdb_fn)
yose_trails_utm <- st_read(gdb_fn, layer="Trails") %>% 
  st_transform(epsg_utm11n_nad83)

## Load the nngeo package
library(nngeo)

## Run the st_nn, return results as list
closest_trail_lst <- st_nn(yose_campgrnds_utm, yose_trails_utm, sparse = TRUE, progress = FALSE)

closest_trail_idx <- unlist(closest_trail_lst)
closest_trail_idx
```

Plot the results:

```{r}
## Plot results
rainbow_cols <- rainbow(nrow(yose_campgrnds_utm), end=5/6)
tm_shape(yose_trails_utm, bbox=yose_campgrnds_utm) + 
  tm_lines(col="gray90") +
  tm_shape(yose_trails_utm %>% slice(closest_trail_idx)) + 
  tm_lines(col="red", lwd=2) +
  tm_shape(yose_campgrnds_utm) + 
  tm_symbols(col="POINAME", palette = rainbow_cols, size=0.5) + 
  tm_layout(legend.show = FALSE)

```



# End

Click on the 'Preview' button in the RStudio toolbar to save a copy of your work as HTML.


