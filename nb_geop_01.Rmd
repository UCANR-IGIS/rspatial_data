---
title: "Geoprocessing I"
output: 
  html_notebook: 
    css: nb.css
---

# About this R Notebook

R Notebooks are a 'flavor' of R markdown that combine plain text with R commands in code chunks. You can (and should!) edit them, and save it every few minutes like anything else!

If you're in RStudio, just go ahead and *minimize the console window*. You won't need it, because when you run the R commands the *output appears below the code chunk*.

Keyboard shortcuts:

- run the current line of R: *ctrl + enter*

 - run everything in the current code chunk: *ctrl + shift + enter*

 - insert a new code chunk: *ctrl + alt + i*

# Setup

First, load the libraries for this exercise.

```{r setup}
library(sf)
library(dplyr)
library(units)
library(tibble)
library(tmap)
```

Next, check the working directory used by the notebook. It should default to the location of the Rmd file (which in our case should be the parent folder of the 'data' folder).

```{r}
getwd()
```
# Compute the area of Yosemite

First we should import the boundary and project it to UTM.

```{r}
## Define a convenience variable for UTM Zone 11
epsg_utm11n_nad83 <- 26911

## Import the YNP border
yose_bnd_utm <- st_read(dsn="./data", layer="yose_boundary") %>% 
  st_transform(epsg_utm11n_nad83)
```
Find the of the park boundary:

```{r}
## Compute the area of the park
yose_area <- yose_bnd_utm %>% st_area()
yose_area
```

Large numbers are hard to interpret! Display the units in square-miles:


```{r}
library(units)

## View in hectacres
set_units(yose_area, ha)

## View in square miles
set_units(yose_area, mi^2)
```

# YOUR TURN!

Import the burned area layer from historical fires (code provided below). 

```{r}
firehist_gdb <- "./data/yose_firehistory.gdb"
file.exists(firehist_gdb)

## View the layers in this source
st_layers(firehist_gdb)

## Import the 'Fire History Polys' layer  (case sensitive!)
yose_firepolys_utm <- st_read(firehist_gdb, layer="YNP_FireHistoryPolys")
```

Now compute the area of each fire. Which was the biggest fire?

```{r}
# The area of each fire is...

```

Solution: see https://ucanr-igis.github.io/rspatial_scgis20/slides/geoprocessing.html

# How many miles of primary roads are there?

First import the roads and inspect the attribute table.

```{r}
## Import the roads
gdb_fn <- "./data/yose_roads.gdb"
yose_roads <- st_read(gdb_fn, "Yosemite_Roads")
glimpse(yose_roads)
```

Next, write an expression that returns the total length of all primary roads.

```{r}
## Load the units package so we can convert meters to miles
library(units)

## Use a mix of functions from dplyr, sf, base R, and units 
yose_roads %>% 
  dplyr::filter(RDCLASS == "Primary") %>%   ## grab just the primary roads
  sf::st_length() %>%                       ## compute length of each segment (as numeric vector)
  sum() %>%                                 ## take the sum
  units::set_units("miles")                 ## convert to miles
```

# YOUR TURN!

How many miles of Secondary roads are there?

```{r}
## How many miles of Secondary roads are there?

```

Answer: 191 miles. See <https://ucanr-igis.github.io/rspatial_scgis20/slides/geoprocessing.html>

# Find centroids of watersheds

First, import the watersheds:

```{r}
## Import watersheds
gpkg_watershd_fn <- "./data/yose_watersheds.gpkg"
file.exists(gpkg_watershd_fn)
yose_watersheds <- st_read(gpkg_watershd_fn, layer="calw221")
```

Plot them:

```{r}
## Plot it
plot(st_geometry(yose_watersheds), axes=TRUE)
```

Next, compute & plot the centroids:

```{r}
yose_watersheds_ctr <- yose_watersheds %>% st_centroid()

## Plot it
tm_shape(yose_watersheds) + tm_borders() +
  tm_shape(yose_watersheds_ctr) + tm_symbols(size=0.3, col="red")
```

# Example: Buffer the Campgrounds

First import the campgrounds (which are part of the yose_poi Shapefile):

```{r}
## Define a convenience variable for UTM Zone 11
epsg_utm11n_nad83 <- 26911

## Import and project the campgrounds
yose_campgrnds_utm <- st_read(dsn="./data", layer="yose_poi") %>% 
  dplyr::filter(POITYPE == 'Campground') %>% 
  dplyr::select(POINAME) %>% 
  st_transform(epsg_utm11n_nad83)
```

Plot them:

```{r}
plot(yose_campgrnds_utm %>% st_geometry(), pch = 16)
```

Next, buffer them (remember the buffer distance should be in map units):

```{r}
## Create the 1km buffer
yose_campgrnds_buff <- st_buffer(yose_campgrnds_utm, dist=1000)

## Plot
tm_shape(yose_bnd_utm) +
  tm_borders() +
tm_shape(yose_campgrnds_buff) +
  tm_polygons(col="red") +
tm_layout(title="1km buffer around campgrounds", 
          title.bg.color="white") +
tm_scale_bar(position = c("right", "bottom"))
```

# Example: Union Features

Union all the burn scars for 1980s. What was the total area burned?

First we pull out all the fires for the 1980s:

```{r}
## Extract fire scars from the 1980s
yose_fires_80s <- yose_firepolys_utm %>% filter(YEAR >= 1980 & YEAR <=1989) 
nrow(yose_fires_80s)
```
Plot them:

```{r}
## Plot them
plot(yose_bnd_utm %>% st_geometry(), col=NA, border="red")
plot(yose_fires_80s %>% st_geometry(), col=NA, border="gray50", add=TRUE)
```

Next we union the polygons and compute the area.

```{r}
## Union the polygons (to remove overlapping polygons)
yose_fires_80s_union <- yose_fires_80s %>% st_union()
plot(yose_bnd_utm %>% st_geometry(), col=NA, border="red")
plot(yose_fires_80s_union %>% st_geometry(), col="gray80", border="gray60", add=TRUE)
```

Compute the total area, displaying the units in square miles

```{r}
yose_fires_80s_union %>% st_area() %>% set_units(mi2)
```

# End

Congratulations on finishing the Notebook! Save it (again).

Click on the 'Preview' button in the RStudio toolbar to save a copy of your work as HTML.


